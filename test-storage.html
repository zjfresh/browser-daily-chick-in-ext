<!DOCTYPE html>
<html>
<head>
    <title>å­˜å‚¨åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; }
        button { padding: 10px 15px; margin: 5px; }
        .log { background: #f5f5f5; padding: 10px; max-height: 400px; overflow-y: auto; font-family: monospace; }
        .result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .result.success { background: #d4edda; color: #155724; }
        .result.error { background: #f8d7da; color: #721c24; }
        input { padding: 5px; margin: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ” å­˜å‚¨åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>åŸºç¡€å­˜å‚¨æµ‹è¯•</h2>
        <div>
            <input type="text" id="testConfigId" placeholder="é…ç½®ID (å¦‚: test123)" value="test123">
            <input type="date" id="testDate" placeholder="æ—¥æœŸ">
            <button onclick="testSetDate()">è®¾ç½®æ—¥æœŸ</button>
            <button onclick="testGetDate()">è¯»å–æ—¥æœŸ</button>
            <button onclick="testDeleteDate()">åˆ é™¤æ—¥æœŸ</button>
        </div>
        <div id="storageResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ç°æœ‰é…ç½®æµ‹è¯•</h2>
        <button onclick="testExistingConfigs()">æµ‹è¯•ç°æœ‰é…ç½®å­˜å‚¨</button>
        <button onclick="showAllStorage()">æ˜¾ç¤ºæ‰€æœ‰å­˜å‚¨æ•°æ®</button>
        <button onclick="manualRefreshOptions()">æ‰‹åŠ¨åˆ·æ–°é…ç½®é¡µé¢</button>
        <div id="configResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>å®æ—¶æ—¥å¿—</h2>
        <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="logs" class="log"></div>
    </div>

    <script>
        // æ‹¦æˆªconsole.logå¹¶æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addLogToPage(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLogToPage(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLogToPage('ERROR: ' + args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLogToPage('WARN: ' + args.join(' '), 'warn');
        };

        async function testSetDate() {
            const resultDiv = document.getElementById('storageResult');
            try {
                if (!window.Utils) {
                    throw new Error('Utilsä¸å¯ç”¨');
                }

                const configId = document.getElementById('testConfigId').value;
                const dateInput = document.getElementById('testDate').value;
                const dateToSet = dateInput || Utils.getTodayString();

                console.log(`=== æµ‹è¯•è®¾ç½®æ—¥æœŸ ===`);
                console.log(`é…ç½®ID: ${configId}`);
                console.log(`æ—¥æœŸ: ${dateToSet}`);
                
                await Utils.setLastOpenDate(configId, dateToSet);
                
                resultDiv.innerHTML = `âœ… æˆåŠŸè®¾ç½® ${configId} = ${dateToSet}`;
                resultDiv.className = 'result success';
                
            } catch (error) {
                console.error('è®¾ç½®æ—¥æœŸå¤±è´¥:', error);
                resultDiv.innerHTML = `âŒ è®¾ç½®å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testGetDate() {
            const resultDiv = document.getElementById('storageResult');
            try {
                if (!window.Utils) {
                    throw new Error('Utilsä¸å¯ç”¨');
                }

                const configId = document.getElementById('testConfigId').value;
                
                console.log(`=== æµ‹è¯•è¯»å–æ—¥æœŸ ===`);
                console.log(`é…ç½®ID: ${configId}`);
                
                const date = await Utils.getLastOpenDate(configId);
                
                resultDiv.innerHTML = `ğŸ“… è¯»å–ç»“æœ: ${configId} = ${date || '(null)'}`;
                resultDiv.className = 'result success';
                
            } catch (error) {
                console.error('è¯»å–æ—¥æœŸå¤±è´¥:', error);
                resultDiv.innerHTML = `âŒ è¯»å–å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testDeleteDate() {
            const resultDiv = document.getElementById('storageResult');
            try {
                if (!window.Utils) {
                    throw new Error('Utilsä¸å¯ç”¨');
                }

                const configId = document.getElementById('testConfigId').value;
                
                console.log(`=== æµ‹è¯•åˆ é™¤æ—¥æœŸ ===`);
                console.log(`é…ç½®ID: ${configId}`);
                
                await Utils.setLastOpenDate(configId, null);
                
                // éªŒè¯åˆ é™¤
                const verifyDate = await Utils.getLastOpenDate(configId);
                
                resultDiv.innerHTML = `ğŸ—‘ï¸ åˆ é™¤ç»“æœ: ${configId} = ${verifyDate || '(å·²åˆ é™¤)'}`;
                resultDiv.className = 'result success';
                
            } catch (error) {
                console.error('åˆ é™¤æ—¥æœŸå¤±è´¥:', error);
                resultDiv.innerHTML = `âŒ åˆ é™¤å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testExistingConfigs() {
            const resultDiv = document.getElementById('configResult');
            try {
                if (!window.Utils) {
                    throw new Error('Utilsä¸å¯ç”¨');
                }

                console.log(`=== æµ‹è¯•ç°æœ‰é…ç½® ===`);
                const configs = await Utils.getConfigs();
                console.log(`æ‰¾åˆ° ${configs.length} ä¸ªé…ç½®`);
                
                let results = `<strong>é…ç½®æ•°é‡:</strong> ${configs.length}<br>`;
                
                for (const config of configs) {
                    const lastOpenDate = await Utils.getLastOpenDate(config.id);
                    console.log(`é…ç½® ${config.id}: ${lastOpenDate || 'ä»æœª'}`);
                    
                    results += `<br><strong>${config.id}</strong>: ${lastOpenDate || 'ä»æœª'}`;
                }
                
                resultDiv.innerHTML = results;
                resultDiv.className = 'result success';
                
            } catch (error) {
                console.error('æµ‹è¯•ç°æœ‰é…ç½®å¤±è´¥:', error);
                resultDiv.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function showAllStorage() {
            const resultDiv = document.getElementById('configResult');
            try {
                console.log(`=== æ˜¾ç¤ºæ‰€æœ‰å­˜å‚¨æ•°æ® ===`);
                
                chrome.storage.local.get(null, (items) => {
                    if (chrome.runtime.lastError) {
                        throw new Error(chrome.runtime.lastError.message);
                    }
                    
                    const lastOpenItems = {};
                    for (const [key, value] of Object.entries(items)) {
                        if (key.startsWith('lastOpen_')) {
                            lastOpenItems[key] = value;
                        }
                    }
                    
                    console.log('æ‰€æœ‰lastOpen_ç›¸å…³å­˜å‚¨:', lastOpenItems);
                    
                    let results = '<strong>æ‰€æœ‰lastOpen_å­˜å‚¨:</strong><br>';
                    if (Object.keys(lastOpenItems).length === 0) {
                        results += '(æ— æ•°æ®)';
                    } else {
                        for (const [key, value] of Object.entries(lastOpenItems)) {
                            results += `<br><strong>${key}</strong>: ${value}`;
                        }
                    }
                    
                    resultDiv.innerHTML = results;
                    resultDiv.className = 'result success';
                });
                
            } catch (error) {
                console.error('æ˜¾ç¤ºå­˜å‚¨æ•°æ®å¤±è´¥:', error);
                resultDiv.innerHTML = `âŒ æ˜¾ç¤ºå¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function manualRefreshOptions() {
            try {
                console.log('=== æ‰‹åŠ¨åˆ·æ–°é…ç½®é¡µé¢æ•°æ® ===');
                
                // å‘é…ç½®é¡µé¢å‘é€åˆ·æ–°æ¶ˆæ¯
                chrome.runtime.sendMessage({
                    action: 'refreshOptions'
                }, (response) => {
                    console.log('åˆ·æ–°é…ç½®é¡µé¢å“åº”:', response);
                });
                
            } catch (error) {
                console.error('åˆ·æ–°é…ç½®é¡µé¢å¤±è´¥:', error);
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸä¸ºé»˜è®¤å€¼
        window.addEventListener('load', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('testDate').value = today;
            console.log('ğŸ” å­˜å‚¨åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html> 